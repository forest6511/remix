name: Sync Fork
on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout forked repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0
          
      - name: Set up Git user
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          
      - name: Sync excluding workflows
        run: |
          git remote add upstream https://github.com/remix-run/remix.git
          git fetch upstream
          git checkout main
          # バックアップを作成
          cp -r .github/workflows/sync.yml /tmp/
          # 上流の変更をマージ
          git merge upstream/main
          # 元のsync.ymlを復元
          mkdir -p .github/workflows/
          cp /tmp/sync.yml .github/workflows/
          # 他のワークフローファイルを削除
          find .github/workflows/ -type f ! -name 'sync.yml' -delete
          git add .
          git commit -m "Sync fork and preserve sync workflow"
          
      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PERSONAL_TOKEN }}
        run: |
          git push "https://${{ secrets.GH_PERSONAL_TOKEN }}@github.com/${{ github.repository }}" main
